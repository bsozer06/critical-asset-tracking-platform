<div class="telemetry-panel">
  <mat-form-field appearance="outline" class="filter-field">
    <mat-label>Search Assets</mat-label>
    <input matInput (keyup)="applyFilter($event)" placeholder="Type to filter...">
    <button mat-icon-button matSuffix *ngIf="filterValue" (click)="filterValue=''; applyFilterInternal();">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>
  <cdk-virtual-scroll-viewport itemSize="64" class="table-viewport">
    <table mat-table 
       [dataSource]="filteredAssets" 
       multiTemplateDataRows
       class="mat-elevation-z2 asset-table">

      <!-- ID -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let asset">
           <span class="asset-id">{{asset.id}}</span> 
        </td>
      </ng-container>

      <!-- Location -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>Location</th>
        <td mat-cell *matCellDef="let asset">
          <span class="asset-location">{{asset.location}}</span> 
        </td>
      </ng-container>

      <!-- Speed -->
      <ng-container matColumnDef="speed">
        <th mat-header-cell *matHeaderCellDef>Speed</th>
        <td mat-cell *matCellDef="let asset">
            <span class="asset-speed">{{asset.speed}}</span> 
        </td>
      </ng-container>

      <!-- Date -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let asset">{{asset.date | date:'short'}}</td>
      </ng-container>

      <!-- Expand Icon -->
      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let asset">
          <button mat-icon-button 
                  (click)="toggleRow(asset); $event.stopPropagation()"
                  [class.expanded]="isExpanded(asset)">
            <mat-icon>{{ isExpanded(asset) ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        </td>
      </ng-container>


      <!-- ROWS -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

      <!-- MAIN ROW -->
      <tr mat-row 
          *matRowDef="let row; columns: displayedColumns"
          class="main-row"
          [class.expanded]="isExpanded(row)"
          (click)="toggleRow(row)">
      </tr>

      <!-- DETAIL ROW -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let asset" 
            [attr.colspan]="displayedColumns.length">

          <div class="detail-wrapper">
            <div class="detail-box">
              <div><strong>ID:</strong> {{asset.id}}</div>
              <div><strong>Location:</strong> {{asset.location}}</div>
              <div><strong>Speed:</strong> {{asset.speed}}</div>
              <div><strong>Date:</strong> {{asset.date | date:'full'}}</div>
            </div>

          </div>

        </td>
      </ng-container>

      <tr mat-row 
          *matRowDef="let row; columns: ['expandedDetail']; when: isExpansionDetailRow"
          class="detail-row">
      </tr>

    </table>

    <div *ngIf="filteredAssets.length === 0" class="empty-state">
      <mat-icon>search_off</mat-icon>
      <span>No assets found.</span>
    </div>
  </cdk-virtual-scroll-viewport>
</div>
